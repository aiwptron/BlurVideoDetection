<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blur Background Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        input[type="file"] {
            margin-bottom: 20px;
        }
        img {
            max-width: 480px;
            max-height: 360px;
            border: 2px solid #333;
            margin-bottom: 20px;
        }
        .result {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>Blur Background Detection</h1>
    <input type="file" id="imageInput" accept="image/*">
    <img id="uploadedImage" alt="Uploaded Image" style="display:none;">
    <div class="result" id="result"></div>

    <script>
        (function () {
            var imageInput = document.getElementById('imageInput');
            var uploadedImage = document.getElementById('uploadedImage');
            var resultDiv = document.getElementById('result');

            imageInput.addEventListener('change', function (event) {
                var file = event.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        uploadedImage.src = e.target.result;
                        uploadedImage.style.display = 'block';
                        detectBlurBackground(uploadedImage);
                    };
                    reader.readAsDataURL(file);
                }
            });

            function detectBlurBackground(imageElement) {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var captureWidth = 144;
                var captureHeight = 144;

                canvas.width = captureWidth;
                canvas.height = captureHeight;

                setTimeout(function () {
                    ctx.drawImage(imageElement, 0, 0, captureWidth, captureHeight, 0, 0, captureWidth, captureHeight);
                    var focusScore1 = calculateFocusScore(ctx, captureWidth, captureHeight);

                    ctx.clearRect(0, 0, captureWidth, captureHeight);
                    ctx.drawImage(imageElement, imageElement.width - captureWidth, 0, captureWidth, captureHeight, 0, 0, captureWidth, captureHeight);
                    var focusScore2 = calculateFocusScore(ctx, captureWidth, captureHeight);

                    var isBlurred = (focusScore1 < 2 && focusScore2 < 2) || (focusScore1 < 1 || focusScore2 < 1);
                    resultDiv.textContent = 'Focus Score 1: ' + focusScore1.toFixed(2) + ', Focus Score 2: ' + focusScore2.toFixed(2) + '. Background is ' + (isBlurred ? 'Blurred' : 'Not Blurred') + '.';

                }, 2000);
            }

            function calculateFocusScore(context, width, height) {
                var imageData = context.getImageData(0, 0, width, height);
                var grayscale = convertToGrayscale(imageData);
                var laplacian = applyLaplacian(grayscale, width, height);
                return calculateVariance(laplacian);
            }

            function convertToGrayscale(imageData) {
                var data = imageData.data;
                var grayscale = [];
                for (var i = 0; i < data.length; i += 4) {
                    var gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    grayscale.push(gray);
                }
                return grayscale;
            }

            function applyLaplacian(grayscale, width, height) {
                var result = new Array(grayscale.length).fill(0);
                var laplacianKernel = [
                    [0, 1, 0],
                    [1, -4, 1],
                    [0, 1, 0]
                ];

                for (var y = 1; y < height - 1; y++) {
                    for (var x = 1; x < width - 1; x++) {
                        var sum = 0;
                        for (var ky = -1; ky <= 1; ky++) {
                            for (var kx = -1; kx <= 1; kx++) {
                                var pixel = grayscale[(y + ky) * width + (x + kx)];
                                var weight = laplacianKernel[ky + 1][kx + 1];
                                sum += pixel * weight;
                            }
                        }
                        result[y * width + x] = sum;
                    }
                }
                return result;
            }

            function calculateVariance(data) {
                var sum = 0;
                for (var i = 0; i < data.length; i++) {
                    sum += data[i];
                }
                var mean = sum / data.length;

                var varianceSum = 0;
                for (var j = 0; j < data.length; j++) {
                    varianceSum += Math.pow(data[j] - mean, 2);
                }
                return varianceSum / data.length;
            }
        })();
    </script>
</body>
</html>
