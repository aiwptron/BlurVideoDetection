<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blur Background Detection </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        input[type="file"] {
            margin-bottom: 20px;
        }
        table {
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #ddd;
        }
        .download-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .download-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Blur Background Detection </h1>
    <input type="file" id="imageInput" accept="image/*" multiple>
    <table id="resultTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Focus Score 1</th>
                <th>Brightness 1</th>
                <th>Focus Score 2</th>
                <th>Brightness 2</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="download-btn" id="downloadCSV" style="display: none;">Download CSV</button>

    <script>
        (function () {
            var imageInput = document.getElementById('imageInput');
            var resultTableBody = document.querySelector('#resultTable tbody');
            var downloadBtn = document.getElementById('downloadCSV');
            var results = [];
            var BRIGHTNESS_THRESHOLD_BRIGHT = 220; // Brightness threshold for marking as Bright
            var BRIGHTNESS_THRESHOLD_DARK = 50;  // Brightness threshold for marking as Dark

            imageInput.addEventListener('change', function (event) {
                var files = Array.prototype.slice.call(event.target.files);
                resultTableBody.innerHTML = ''; // Clear previous results
                results = []; // Clear previous results for CSV

                files.forEach(function (file) {
                    loadImage(file).then(function (imageData) {
                        calculateMetrics(imageData.image, 480, 360).then(function (metrics) {
                            var status;
                            if (metrics.brightness1 > BRIGHTNESS_THRESHOLD_BRIGHT || metrics.brightness2 > BRIGHTNESS_THRESHOLD_BRIGHT) {
                                status = 'Bright';
                            } else if (metrics.brightness1 < BRIGHTNESS_THRESHOLD_DARK || metrics.brightness2 < BRIGHTNESS_THRESHOLD_DARK) {
                                status = 'Dark';
                            } else if (metrics.focusScore1 < 10 && metrics.focusScore2 < 10) {
                                status = 'Blurred';
                            } else {
                                status = 'Not Blurred';
                            }

                            addTableRow(file.name, metrics.focusScore1, metrics.brightness1, metrics.focusScore2, metrics.brightness2, status);
                            results.push({
                                name: file.name,
                                focusScore1: metrics.focusScore1,
                                brightness1: metrics.brightness1,
                                focusScore2: metrics.focusScore2,
                                brightness2: metrics.brightness2,
                                status: status
                            });

                            if (results.length > 0) {
                                downloadBtn.style.display = 'inline-block';
                            }
                        });
                    });
                });
            });

            function loadImage(file) {
                return new Promise(function (resolve) {
                    var img = new Image();
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        img.src = e.target.result;
                        img.onload = function () {
                            resolve({ image: img, name: file.name });
                        };
                    };
                    reader.readAsDataURL(file);
                });
            }

            function calculateMetrics(image, width, height) {
                return new Promise(function (resolve) {
                    // Resize the image to 480x360
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(image, 0, 0, width, height);

                    // Top-Left Region
                    var metrics1 = calculateRegionMetrics(ctx, 144, 144, 0, 0);

                    // Top-Right Region
                    var metrics2 = calculateRegionMetrics(ctx, 144, 144, width - 144, 0);

                    resolve({
                        focusScore1: metrics1.focusScore,
                        brightness1: metrics1.brightness,
                        focusScore2: metrics2.focusScore,
                        brightness2: metrics2.brightness
                    });
                });
            }

            function calculateRegionMetrics(context, width, height, offsetX, offsetY) {
                var imageData = context.getImageData(offsetX, offsetY, width, height);
                var data = imageData.data;
                var grayscale = [];
                var brightnessSum = 0;

                for (var i = 0; i < data.length; i += 4) {
                    var gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    grayscale.push(gray);
                    brightnessSum += gray;
                }

                var laplacianKernel = [
                    [0, 1, 0],
                    [1, -4, 1],
                    [0, 1, 0]
                ];
                var result = new Array(grayscale.length).fill(0);

                for (var y = 1; y < height - 1; y++) {
                    for (var x = 1; x < width - 1; x++) {
                        var sum = 0;
                        for (var ky = -1; ky <= 1; ky++) {
                            for (var kx = -1; kx <= 1; kx++) {
                                var pixel = grayscale[(y + ky) * width + (x + kx)];
                                var weight = laplacianKernel[ky + 1][kx + 1];
                                sum += pixel * weight;
                            }
                        }
                        result[y * width + x] = sum;
                    }
                }

                return {
                    focusScore: calculateVariance(result),
                    brightness: brightnessSum / (width * height)
                };
            }

            function calculateVariance(data) {
                var validData = data.filter(function (value) { return !isNaN(value); });
                var mean = validData.reduce(function (sum, val) { return sum + val; }, 0) / validData.length;
                var variance = validData.reduce(function (sum, val) { return sum + Math.pow(val - mean, 2); }, 0) / validData.length;
                return variance;
            }

            function addTableRow(name, focusScore1, brightness1, focusScore2, brightness2, status) {
                var row = document.createElement('tr');
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${focusScore1.toFixed(2)}</td>
                    <td>${brightness1.toFixed(2)}</td>
                    <td>${focusScore2.toFixed(2)}</td>
                    <td>${brightness2.toFixed(2)}</td>
                    <td>${status}</td>
                `;
                resultTableBody.appendChild(row);
            }

            downloadBtn.addEventListener('click', function () {
                var csvContent = 'data:text/csv;charset=utf-8,Image Name,Focus Score 1,Brightness 1,Focus Score 2,Brightness 2,Status\n' +
                    results.map(function (row) {
                        return row.name + ',' + row.focusScore1.toFixed(2) + ',' + row.brightness1.toFixed(2) + ',' + row.focusScore2.toFixed(2) + ',' + row.brightness2.toFixed(2) + ',' + row.status;
                    }).join('\n');
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'blur_detection_results_with_brightness.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        })();
    </script>
</body>
</html>
